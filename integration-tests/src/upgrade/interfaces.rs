// Even though Bridgehub is defined in `zksync_os_contract_interface`, we redefine it here,
// since for an upgrade we need much more internals than the rest of the codebase cares about.
alloy::sol! {
    #![sol(all_derives)]

    #[sol(rpc)]
    contract Bridgehub {
        // Getters
        function owner() external view returns (address);
        function chainTypeManager(uint256 _chainId) external view returns (address);
        function getZKChain(uint256 _chainId) external view returns (address);

        // Upgrade functionality
        function pauseMigration() external;
    }

    enum Action {
        Add,
        Replace,
        Remove
    }

    struct FacetCut {
        address facet;
        Action action;
        bool isFreezable;
        bytes4[] selectors;
    }

    struct DiamondCutData {
        FacetCut[] facetCuts;
        address initAddress;
        bytes initCalldata;
    }

    #[sol(rpc)]
    contract ChainTypeManager {
        function owner() external view returns (address);

        function setNewVersionUpgrade(
            DiamondCutData calldata _cutData,
            uint256 _oldProtocolVersion,
            uint256 _oldProtocolVersionDeadline,
            uint256 _newProtocolVersion
        ) external;

        function getProtocolVersion(uint256 _chainId) external view returns (uint256);
    }


    // Represents the diamond proxy of the ZK chain on L1
    #[sol(rpc)]
    contract ZkChain {
        function owner() external view returns (address);

        // Getters facet
        function getAdmin() external view returns (address);

        // Admin facet
        function upgradeChainFromVersion(uint256 _protocolVersion, DiamondCutData calldata _cutData) external;
        function getTotalBatchesCommitted() external view returns (uint256);
        function getTotalBatchesVerified() external view returns (uint256);
        function getTotalBatchesExecuted() external view returns (uint256);
    }

    #[sol(rpc)]
    contract ChainAdmin {
        function owner() external view returns (address);
        function setUpgradeTimestamp(uint256 _protocolVersion, uint256 _upgradeTimestamp) external;
    }

    struct L2CanonicalTransaction {
        uint256 txType;
        uint256 from;
        uint256 to;
        uint256 gasLimit;
        uint256 gasPerPubdataByteLimit;
        uint256 maxFeePerGas;
        uint256 maxPriorityFeePerGas;
        uint256 paymaster;
        uint256 nonce;
        uint256 value;
        uint256[4] reserved;
        bytes data;
        bytes signature;
        uint256[] factoryDeps;
        bytes paymasterInput;
        bytes reservedDynamic;
    }

    struct VerifierParams {
        bytes32 recursionNodeLevelVkHash;
        bytes32 recursionLeafLevelVkHash;
        bytes32 recursionCircuitsSetVksHash;
    }

    struct ProposedUpgrade {
        L2CanonicalTransaction l2ProtocolUpgradeTx;
        bytes32 bootloaderHash;
        bytes32 defaultAccountHash;
        bytes32 evmEmulatorHash;
        address verifier;
        VerifierParams verifierParams;
        bytes l1ContractsUpgradeCalldata;
        bytes postUpgradeCalldata;
        uint256 upgradeTimestamp;
        uint256 newProtocolVersion;
    }

    // Bytecode for default upgrade is hardcoded, since putting it to dependencies would significantly
    // slow down the compilation process of integration tests.
    // If you need to change it, take the `bytecode` from `contracts/l1-contracts/out/DefaultUpgrade.sol/DefaultUpgrade.json`
    #[sol(
        rpc,
        bytecode = "0x6080604052348015600e575f5ffd5b50611c208061001c5f395ff3fe608060405234801561000f575f5ffd5b5060043610610029575f3560e01c806316ef13031461002d575b5f5ffd5b61004061003b366004611152565b610052565b60405190815260200160405180910390f35b5f61005c82610084565b507f33774e659306e47509050e97cb651e731180a42d458212294d30751925c551a292915050565b5f8161014001354210156100d6576040517f0875398200000000000000000000000000000000000000000000000000000000815261014083013560048201524260248201526044015b60405180910390fd5b60325473ffffffffffffffffffffffffffffffffffffffff16155f80610101610160860135846101c3565b909250905061011b61011761010087018761118a565b5050565b61013761012e60a087016080880161121a565b8660a0016103f0565b61014f85602001358660400135876060013584610402565b821561016c576101696101628680611233565b8383610426565b93505b61017d61011761012087018761118a565b838561016001357f6bd09c836cb5c068d0e56c5463173036c9e0664c3c89a09c4b2ea71106abfc37876040516101b39190611535565b60405180910390a3505050919050565b6021545f908190808511610203576040517f88d7b49800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f5f610230610211846105a3565b63ffffffff604082901c169167ffffffffffffffff602083901c169190565b50915091508163ffffffff165f14610274576040517f5c598b6000000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f610281610211896105a3565b509650905063ffffffff8116156102c4576040517f72ea85ad00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f6102cf83886116af565b63ffffffff169050805f036102e357600195505b6064811115610328576040517fd328c12a00000000000000000000000000000000000000000000000000000000815260646004820152602481018290526044016100cd565b851580156103335750875b156103b35760225415610379576022546040517f101ba74800000000000000000000000000000000000000000000000000000000815260048101919091526024016100cd565b602354156103b3576040517fa0f4724500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6021899055604051899086907f4235104f56661fe2e9d2f2a460b42766581bc45ce366c6a30a9f86c8a2b371a7905f90a350505050509250929050565b6103f982610644565b610117816106d8565b61040c8482610771565b61041683826107f4565b6104208282610877565b50505050565b5f8335810361043657505f61059c565b61043e6108fa565b84351461047a576040517f5cb29523000000000000000000000000000000000000000000000000000000008152843560048201526024016100cd565b81156104b2576040517fd7f50a9d00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f846040516020016104c491906116cb565b604051602081830303815290604052905061050e856104e2906118ee565b601a54602654603c548592916d0100000000000000000000000000900463ffffffff169060ff16610912565b61051f61051a866118ee565b610a7a565b8363ffffffff1685610100013514610576576040517fd2c011d6000000000000000000000000000000000000000000000000000000008152610100860135600482015263ffffffff851660248201526044016100cd565b61058c610587610200870187611a62565b610df7565b8051602090910120602281905590505b9392505050565b5f6bffffffffffffffffffffffff821115610640576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602660248201527f53616665436173743a2076616c756520646f65736e27742066697420696e203960448201527f362062697473000000000000000000000000000000000000000000000000000060648201526084016100cd565b5090565b73ffffffffffffffffffffffffffffffffffffffff81166106625750565b600a805473ffffffffffffffffffffffffffffffffffffffff8381167fffffffffffffffffffffffff0000000000000000000000000000000000000000831681179093556040519116919082907f2ff4895c300d6993c27f2bb507b4b59d29464dc640af727383451365631ba8b2905f90a35050565b80351580156106e957506020810135155b80156106f757506040810135155b156106ff5750565b604080516060810182526014805482526015805460208085019190915260168054858701528635909355850135905583830135905590517f4c055dbc5f14dcb6e081c9421d9657d950dcd6372f6db0a714b9135171cbc15d906107659083908590611ac6565b60405180910390a15050565b8161077a575050565b80156107b2576040517f962fd7d000000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6107bb82610e32565b6017805490839055604051839082907f271b33af94e3f065ecd8659833e6b1daf851f063700c36ddefefab35d4ce4746905f90a3505050565b816107fd575050565b8015610835576040517f559cc34e00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b61083e82610e32565b6018805490839055604051839082907f36df93a47cc02081d9d8208022ab736fdf98fac566e5fc6f5762bf7666e521f3905f90a3505050565b81610880575050565b80156108b8576040517fc231eccd00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6108c182610e32565b603a805490839055604051839082907f23ee925b859027449030409cb326f0931c0aafa5a72a1306ca1ec354e839e639905f90a3505050565b603c545f9060ff1661090c575060fe90565b50607e90565b5f6109238660600151865184610ef7565b90508381111561095f576040517ff0b4e88f00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b828660800151826109709190611b2c565b11156109c257828660800151826109879190611b2c565b6040517f959f26fb000000000000000000000000000000000000000000000000000000008152600481019290925260248201526044016100cd565b8180156109d1575060a0860151155b80156109df57508551607e14155b15610a16576040517f1bc36e6700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b80610a3a865188610160015151896101a00151518a608001518b60a0015188610f55565b1115610a72576040517f47b3b14500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b505050505050565b602081015161ffff1015610abc575f6040517f5f1aa1540000000000000000000000000000000000000000000000000000000081526004016100cd9190611b6c565b604081015173ffffffffffffffffffffffffffffffffffffffff1015610b115760016040517f5f1aa1540000000000000000000000000000000000000000000000000000000081526004016100cd9190611b6c565b60e081015115610b505760026040517f5f1aa1540000000000000000000000000000000000000000000000000000000081526004016100cd9190611b6c565b61012081015115610b905760036040517f5f1aa1540000000000000000000000000000000000000000000000000000000081526004016100cd9190611b6c565b60a081015115610bcf5760046040517f5f1aa1540000000000000000000000000000000000000000000000000000000081526004016100cd9190611b6c565b60c081015115610c0e5760056040517f5f1aa1540000000000000000000000000000000000000000000000000000000081526004016100cd9190611b6c565b6101408101515115610c4f5760066040517f5f1aa1540000000000000000000000000000000000000000000000000000000081526004016100cd9190611b6c565b6101408101516020015173ffffffffffffffffffffffffffffffffffffffff1015610ca95760076040517f5f1aa1540000000000000000000000000000000000000000000000000000000081526004016100cd9190611b6c565b6101408101516040015115610ced5760086040517f5f1aa1540000000000000000000000000000000000000000000000000000000081526004016100cd9190611b6c565b6101408101516060015115610d315760096040517f5f1aa1540000000000000000000000000000000000000000000000000000000081526004016100cd9190611b6c565b6101808101515115610d7257600a6040517f5f1aa1540000000000000000000000000000000000000000000000000000000081526004016100cd9190611b6c565b6101c08101515115610db357600b6040517f5f1aa1540000000000000000000000000000000000000000000000000000000081526004016100cd9190611b6c565b6101e08101515115610df457600c6040517f5f1aa1540000000000000000000000000000000000000000000000000000000081526004016100cd9190611b6c565b50565b6040811115610117576040517f76da24b900000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f81901a600181141580610e6e57507fff00000000000000000000000000000000000000000000000000000000000000600183901a60f81b1615155b15610ea7575f6040517f43e266b00000000000000000000000000000000000000000000000000000000081526004016100cd9190611b86565b6002610eb2836110c7565b610ebc9190611b9a565b5f036101175760036040517f43e266b00000000000000000000000000000000000000000000000000000000081526004016100cd9190611b86565b5f8115610f0557508261059c565b5f610f0f846110ed565b905080851015610f4b576040517f2e311df800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b9093039392505050565b5f811561103057615208610f6a876010611bad565b610f749082611bc4565b90506202059461445c610f926001610f8d8c6088611108565b61113d565b610f9c9190611bad565b610fa69082611bc4565b9050610fb3600189611bad565b610fbd9082611bc4565b90505f855f03610fda57610fd361271083611b2c565b9050610ff3565b85610fe6600a84611bad565b610ff09190611b2c565b90505b5f610fff886058611bad565b90505f61100c8284611bc4565b905061102461101b868361113d565b62030d4061113d565b955050505050506110bd565b62028cf561104b6110436106788a611bad565b610220611108565b6110559082611bc4565b90506110636109a987611bad565b61106d9082611bc4565b905061107c816202a5ac61113d565b90505f61108a866058611bad565b905085611098604089611bad565b6110a29190611bad565b6110ac9082611bc4565b90506110b88183611bc4565b925050505b9695505050505050565b5f8160031a8260026110dd91901a610100611bad565b6110e79190611bc4565b92915050565b6127105f6110fc83600a611bad565b905061059c828261113d565b5f8215611135578161111b600185611bd7565b6111259190611b2c565b611130906001611bc4565b61059c565b5f9392505050565b5f81831161114b578161059c565b5090919050565b5f60208284031215611162575f5ffd5b813567ffffffffffffffff811115611178575f5ffd5b8201610180818503121561059c575f5ffd5b5f5f83357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe18436030181126111bd575f5ffd5b83018035915067ffffffffffffffff8211156111d7575f5ffd5b6020019150368190038213156111eb575f5ffd5b9250929050565b803573ffffffffffffffffffffffffffffffffffffffff81168114611215575f5ffd5b919050565b5f6020828403121561122a575f5ffd5b61059c826111f2565b5f82357ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffda1833603018112611265575f5ffd5b9190910192915050565b5f82357ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffda18336030181126112a1575f5ffd5b90910192915050565b60808183375050565b5f5f83357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe18436030181126112e6575f5ffd5b830160208101925035905067ffffffffffffffff811115611305575f5ffd5b8036038213156111eb575f5ffd5b81835281816020850137505f602082840101525f60207fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f840116840101905092915050565b5f5f83357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe184360301811261138d575f5ffd5b830160208101925035905067ffffffffffffffff8111156113ac575f5ffd5b8060051b36038213156111eb575f5ffd5b8183525f7f07ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8311156113ed575f5ffd5b8260051b80836020870137939093016020019392505050565b803582526020808201359083015260408082013590830152606080820135908301526080808201359083015260a0808201359083015260c0808201359083015260e08082013590830152610100808201359083015261012080820135908301525f6114786101408085019084016112aa565b6114866101c08301836112b3565b6102606101c086015261149e61026086018284611313565b9150506114af6101e08401846112b3565b8583036101e08701526114c3838284611313565b925050506114d561020084018461135a565b8583036102008701526114e98382846113bd565b925050506114fb6102208401846112b3565b85830361022087015261150f838284611313565b925050506115216102408401846112b3565b8583036102408701526110bd838284611313565b602081525f611544838461126f565b610180602084015261155a6101a0840182611406565b602085013560408581019190915285013560608086019190915285013560808086019190915290915061158e9085016111f2565b73ffffffffffffffffffffffffffffffffffffffff811660a0850152506115cf60c0840160a086018035825260208082013590830152604090810135910152565b6115dd6101008501856112b3565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe085840301610120860152611613838284611313565b925050506116256101208501856112b3565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08584030161014086015261165b838284611313565b61014087013561016087810191909152909601356101809095019490945250929392505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b63ffffffff82811682821603908111156110e7576110e7611682565b602081525f61059c6020830184611406565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b604051610200810167ffffffffffffffff8111828210171561172e5761172e6116dd565b60405290565b604051601f82017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe016810167ffffffffffffffff8111828210171561177b5761177b6116dd565b604052919050565b5f82601f830112611792575f5ffd5b6040516080810167ffffffffffffffff811182821017156117b5576117b56116dd565b6040528060808401858111156117c9575f5ffd5b845b818110156117e35780358352602092830192016117cb565b509195945050505050565b5f82601f8301126117fd575f5ffd5b813567ffffffffffffffff811115611817576118176116dd565b61184860207fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f84011601611734565b81815284602083860101111561185c575f5ffd5b816020850160208301375f918101602001919091529392505050565b5f82601f830112611887575f5ffd5b813567ffffffffffffffff8111156118a1576118a16116dd565b8060051b6118b160208201611734565b918252602081850181019290810190868411156118cc575f5ffd5b6020860192505b838310156110bd5782358252602092830192909101906118d3565b5f61026082360312156118ff575f5ffd5b61190761170a565b823581526020808401359082015260408084013590820152606080840135908201526080808401359082015260a0808401359082015260c0808401359082015260e0808401359082015261010080840135908201526101208084013590820152611975366101408501611783565b6101408201526101c083013567ffffffffffffffff811115611995575f5ffd5b6119a1368286016117ee565b610160830152506101e083013567ffffffffffffffff8111156119c2575f5ffd5b6119ce368286016117ee565b6101808301525061020083013567ffffffffffffffff8111156119ef575f5ffd5b6119fb36828601611878565b6101a08301525061022083013567ffffffffffffffff811115611a1c575f5ffd5b611a28368286016117ee565b6101c08301525061024083013567ffffffffffffffff811115611a49575f5ffd5b611a55368286016117ee565b6101e08301525092915050565b5f5f83357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe1843603018112611a95575f5ffd5b83018035915067ffffffffffffffff821115611aaf575f5ffd5b6020019150600581901b36038213156111eb575f5ffd5b8251815260208084015181830152604080850151818401528335606084015290830135608083015282013560a082015260c0810161059c565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f82611b3a57611b3a611aff565b500490565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602160045260245ffd5b60208101600d8310611b8057611b80611b3f565b91905290565b6020810160048310611b8057611b80611b3f565b5f82611ba857611ba8611aff565b500690565b80820281158282048414176110e7576110e7611682565b808201808211156110e7576110e7611682565b818103818111156110e7576110e761168256fea2646970667358221220547f80adef652a37312c30bb7f71c21e71982310680a63a3c9494b0053863e9f64736f6c634300081c0033"
    )]
    contract DefaultUpgrade {
        function upgrade(ProposedUpgrade calldata _proposedUpgrade) public virtual returns (bytes32 txHash);
    }

    enum ContractUpgradeType {
        EraForceDeployment,
        ZKsyncOSSystemProxyUpgrade,
        ZKsyncOSUnsafeForceDeployment
    }

    struct UniversalContractUpgradeInfo {
        ContractUpgradeType upgradeType;
        bytes deployedBytecodeInfo;
        address newAddress;
    }

    #[sol(rpc)]
    contract L2ComplexUpgrader {
        function forceDeployAndUpgradeUniversal(
            UniversalContractUpgradeInfo[] calldata _forceDeployments,
            address _delegateTo,
            bytes calldata _calldata
        ) external payable;
    }

    /// Struct used to pass bytecode info for force deployment of ZKsyncOS contracts.
    struct ForceDeploymentBytecodeInfo {
        bytes32 bytecodeHash;
        uint32 bytecodeSize;
        bytes32 observableBytecodeHash;
    }

    #[sol(rpc)]
    contract BytecodesSupplier {
        /// @notice Publishes the bytecode hash and the bytecode itself.
        /// @param _bytecode Bytecode to be published.
        function publishBytecode(bytes calldata _bytecode) public;

        /// @notice Publishes multiple bytecodes.
        /// @param _bytecodes Array of bytecodes to be published.
        function publishBytecodes(bytes[] calldata _bytecodes) external;
    }
}
